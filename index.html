<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chorderline</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f0f0f0;
      color: #000;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
      position: relative;
      min-height: 100vh;
    }
    .dark-mode {
      background-color: #1e1e1e;
      color: white;
    }
    .section-box {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: background 0.3s;
    }
    .dark-mode .section-box {
      background: #2c2c2c;
    }
    .navbar, .dark-toggle {
      display: flex;
      align-items: center;
    }
    .navbar button, .dark-toggle button {
      margin-right: 10px;
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: transparent;
      font-weight: 600;
      transition: color 0.3s;
    }
    /* Buttons text black in light, white in dark */
    .navbar button, .dark-toggle button {
      color: black;
    }
    body.dark-mode .navbar button, 
    body.dark-mode .dark-toggle button {
      color: white;
    }
    .dark-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    #chordList {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 16px;
      padding-top: 10px;
    }
    .custom-prog-entry {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .custom-prog-entry button {
      background: transparent;
      border: none;
      color: red;
      cursor: pointer;
      font-size: 1em;
    }
    #generationResult {
      white-space: pre-wrap;
      font-family: monospace;
      background: #eee;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }
    body.dark-mode #generationResult {
      background: #333;
    }
  </style>
</head>
<body>

  <h1>üé∏ Chorderline</h1>

  <div class="dark-toggle">
    <button onclick="toggleDarkMode()">Toggle Darkmode</button>
  </div>

  <nav class="navbar section-box">
    <button onclick="showPage('info')">Info</button>
    <button onclick="showPage('setup')">Setup</button>
    <button onclick="showPage('chord')">Chord</button>
    <button onclick="showPage('rhythm')">Rhythm</button>
    <button onclick="showPage('preview')">Preview</button>
  </nav>

  <div id="info" class="page section-box active">
    <h2>Welcome to Chorderline</h2>
    <p>This is a random post-punk chord & rhythm generator. Move through each tab to configure your generation. ‚ÄúSetup‚Äù handles basic key info, ‚ÄúChord‚Äù handles progressions, and so on. Simple as that.</p>
  </div>

  <div id="setup" class="page section-box" style="display:none;">
    <h2>Setup</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
      <div>
        <label for="key">Key:</label>
        <select id="key">
          <option value="C">C</option>
          <option value="C#">C#</option>
          <option value="D">D</option>
          <option value="D#">D#</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="F#">F#</option>
          <option value="G">G</option>
          <option value="G#">G#</option>
          <option value="A">A</option>
          <option value="A#">A#</option>
          <option value="B">B</option>
        </select>
      </div>
      <div>
        <label for="mode">Mode:</label>
        <select id="mode">
          <option value="major">Major</option>
          <option value="minor">Minor</option>
        </select>
      </div>
      <div>
        <label for="tempo">Tempo (BPM):</label>
        <input type="number" id="tempo" min="40" max="240" value="120" />
      </div>
      <div>
        <label for="timesig">Time Signature:</label>
        <select id="timesig">
          <option value="4/4">4/4</option>
          <option value="3/4">3/4</option>
          <option value="6/8">6/8</option>
        </select>
      </div>
    </div>
  </div>

  <div id="chord" class="page section-box" style="display:none;">
    <h2>Chord Progressions</h2>
    <p>Select one or more progressions. A random one will be chosen for generation. You can also add your own!</p>
    <div style="margin-bottom: 10px;">
      <button onclick="toggleCheckboxes(true)">Apply All</button>
      <button onclick="toggleCheckboxes(false)">Disable All</button>
    </div>
    <div id="chordList">
      <label><input type="checkbox" value="I - V - IV" /> I - V - IV</label>
      <label><input type="checkbox" value="I - V - vi - IV" /> I - V - vi - IV</label>
      <label><input type="checkbox" value="V - vi - IV" /> V - vi - IV</label>
      <label><input type="checkbox" value="i - VI - III - V" /> i - VI - III - V</label>
      <label><input type="checkbox" value="I - V - vi - IV - ii - V" /> I - V - vi - IV - ii - V</label>
      <label><input type="checkbox" value="I - V - vi - IV - I" /> I - V - vi - IV - I</label>
      <label><input type="checkbox" value="I - iii - ii - V" /> I - iii - ii - V</label>
      <label><input type="checkbox" value="i - VII - III - v" /> i - VII - III - v</label>
      <label><input type="checkbox" value="vi - I - V - IV" /> vi - I - V - IV</label>
      <label><input type="checkbox" value="i - VI - v - VII" /> i - VI - v - VII</label>
      <label><input type="checkbox" value="I - V - IV - V - vi" /> I - V - IV - V - vi</label>
      <label><input type="checkbox" value="i - VI - iv - VII" /> i - VI - iv - VII</label>
    </div>
    <div style="margin-top: 15px;">
      <label for="customProg">Custom progression (optional):</label>
      <input type="text" id="customProg" placeholder="e.g. i - iv - ‚ô≠VII - v" />
      <button onclick="addCustomProg()">‚úîÔ∏è</button>
    </div>
  </div>

  <div id="rhythm" class="page section-box" style="display:none;">
    <h2>Rhythm</h2>
    <label>Select Pattern:</label>
    <select id="rhythm">
      <option value="stabs">Staccato Stabs</option>
      <option value="drone">Droning Strums</option>
      <option value="16ths">16th Note Machine</option>
      <option value="jerky">Jerky Offbeat</option>
    </select>
  </div>

  <div id="preview" class="page section-box" style="display:none;">
    <h2>Preview</h2>
    <button onclick="generate()">Generate</button>
    <pre id="generationResult">Hit generate to see your random chord progression!</pre>
  </div>

  <script>
    // Notes chromatic scale, sharps & flats normalized
    const chromaticNotes = [
      "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"
    ];
    // Helper to get note index with flats (# and ‚ô≠ normalized)
    function normalizeNote(note) {
      if (note.includes("‚ô≠")) {
        // Flat: find note one semitone down
        let base = note.replace("‚ô≠", "");
        let idx = chromaticNotes.indexOf(base);
        if (idx === -1) return note; // fallback
        let flatIdx = (idx + 11) % 12; // one semitone down, wrap around
        return chromaticNotes[flatIdx];
      } else if (note.includes("#")) {
        // Sharp: direct
        return note.replace("‚ôØ", "#");
      }
      return note;
    }

    // Major scale intervals (semitones)
    const majorIntervals = [0, 2, 4, 5, 7, 9, 11];
    // Minor natural scale intervals
    const minorIntervals = [0, 2, 3, 5, 7, 8, 10];

    // Build scale notes based on key and mode
    function buildScale(key, mode) {
      let rootIndex = chromaticNotes.indexOf(normalizeNote(key));
      let intervals = mode === "major" ? majorIntervals : minorIntervals;
      return intervals.map(i => chromaticNotes[(rootIndex + i) % 12]);
    }

    // Map Roman numerals to scale degree (1-based)
    const romanToDegree = {
      "I": 1, "II": 2, "III": 3, "IV": 4, "V": 5, "VI": 6, "VII": 7,
      "i": 1, "ii": 2, "iii": 3, "iv": 4, "v": 5, "vi": 6, "vii": 7,
      "ii¬∞": 2, "vii¬∞": 7, "i¬∞": 1 // diminished chords
    };

    // Detect diminished chord suffix (¬∞)
    function isDiminished(roman) {
      return roman.includes("¬∞") || roman.includes("dim");
    }

    // Determine chord quality from roman numeral:
    // uppercase = major, lowercase = minor, ¬∞ = diminished
    function getChordQuality(roman) {
      if (isDiminished(roman)) return "dim";
      if (roman.toUpperCase() === roman) return "maj";
      return "min";
    }

    // Apply flats/sharps to roman numeral root (e.g., ‚ô≠VII ‚Üí flat the 7th degree)
    function parseRomanNumeral(rn) {
      // Handle flat/sharp prefixes, e.g. ‚ô≠VII, ‚ôØiv, etc
      let accidental = null;
      let base = rn;
      if (rn.startsWith("‚ô≠")) {
        accidental = -1;
        base = rn.slice(1);
      } else if (rn.startsWith("‚ôØ") || rn.startsWith("#")) {
        accidental = 1;
        base = rn.slice(1);
      }
      // Diminished chord sometimes written as ii¬∞ or vii¬∞
      const quality = getChordQuality(rn);
      // Clean base numeral (remove ¬∞)
      let baseClean = base.replace("¬∞", "");

      // Map numeral to scale degree 1-7
      let degree = romanToDegree[baseClean];
      if (!degree) {
        console.warn("Unknown roman numeral: ", rn);
        return null;
      }

      return { accidental, degree, quality };
    }

    // Calculate chord root note based on degree and scale
    // Applies accidental to degree (e.g. flat VII = degree 7 lowered by 1 semitone)
    function getChordRootNote(scale, accidental, degree) {
      let note = scale[degree - 1];
      if (accidental) {
        // Get chromatic note index and shift by accidental
        let idx = chromaticNotes.indexOf(note);
        let newIdx = (idx + accidental + 12) % 12;
        note = chromaticNotes[newIdx];
      }
      return note;
    }

    // Compose chord name with quality suffix (min or dim)
    // Major chords just show the note name
    function buildChordName(root, quality) {
      if (quality === "maj") return root;
      if (quality === "min") return root + "m";
      if (quality === "dim") return root + "dim";
      return root; // fallback
    }

    // Turn roman numeral progression string into array of chord objects
    function parseProgression(progStr) {
      return progStr.split("-").map(s => s.trim()).filter(s => s.length > 0);
    }

    // Generate chord names from progression
    function generateChordsFromProg(progArr, key, mode) {
      const scale = buildScale(key, mode);
      let chords = [];

      for (let rn of progArr) {
        let parsed = parseRomanNumeral(rn);
        if (!parsed) {
          chords.push("???");
          continue;
        }
        let root = getChordRootNote(scale, parsed.accidental, parsed.degree);
        let chordName = buildChordName(root, parsed.quality);
        chords.push(chordName);
      }
      return chords;
    }

    // Pages nav
    function showPage(id) {
      document.querySelectorAll(".page").forEach(p => p.style.display = "none");
      const page = document.getElementById(id);
      if (page) page.style.display = "block";
    }

    // Toggle all checkboxes in chord list
    function toggleCheckboxes(value) {
      document.querySelectorAll("#chordList input[type=checkbox]").forEach(cb => cb.checked = value);
    }

    // Add custom progression to chord list
    function addCustomProg() {
      const input = document.getElementById("customProg");
      const val = input.value.trim();
      if (!val) return;

      // Make sure it's not a duplicate
      const existingLabels = Array.from(document.querySelectorAll("#chordList label"));
      if (existingLabels.some(l => l.textContent.trim() === val)) {
        alert("That progression already exists!");
        return;
      }

      const container = document.getElementById("chordList");
      const newLabel = document.createElement("label");
      newLabel.innerHTML = `<input type="checkbox" checked value="${val}" /> ${val} <button onclick="this.parentElement.remove()">‚úñ</button>`;
      container.appendChild(newLabel);
      input.value = "";
    }

    // Toggle dark mode
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }

    // Generate function for preview tab
    function generate() {
      // Get key, mode, tempo, time signature
      const key = document.getElementById("key").value;
      const mode = document.getElementById("mode").value;
      const tempo = document.getElementById("tempo").value;
      const timeSig = document.getElementById("timesig").value;

      // Get all checked progressions from chord list
      const checkedProgs = Array.from(document.querySelectorAll("#chordList input[type=checkbox]:checked")).map(cb => cb.value);
      if (checkedProgs.length === 0) {
        alert("Please select at least one chord progression.");
        return;
      }

      // Pick random progression from checked
      const chosenProg = checkedProgs[Math.floor(Math.random() * checkedProgs.length)];
      const progArr = parseProgression(chosenProg);

      // Generate chords
      const chords = generateChordsFromProg(progArr, key, mode);

      // Format output nicely
      let output = "";
      output += `Key: ${key} ${mode.charAt(0).toUpperCase() + mode.slice(1)}\n`;
      output += `Progression (Roman numerals): ${chosenProg}\n`;
      output += `Applied Chords: ${chords.join(" - ")}\n`;
      output += `Tempo: ${tempo} BPM\n`;
      output += `Time Signature: ${timeSig}\n`;

      document.getElementById("generationResult").textContent = output;
      showPage("preview");
    }

  </script>
</body>
</html>
