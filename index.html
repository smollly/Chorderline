<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chorderline</title>
  <style>
    /* --- Base styles --- */
    body {
      background-color: #f0f0f0;
      color: #000;
      font-family: sans-serif;
      padding: 20px;
      transition: background-color 0.5s, color 0.5s;
    }
    .darkmode {
      background-color: #121212;
      color: #fff;
    }
    .section-box {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: background-color 0.5s, color 0.5s;
    }
    .darkmode .section-box {
      background: #1e1e1e;
      color: #fff;
      box-shadow: none;
    }
    nav.navbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
    }
    nav.navbar button {
      background: none;
      border: 1px solid currentColor;
      border-radius: 6px;
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    nav.navbar button:hover {
      background-color: #ddd;
    }
    .darkmode nav.navbar button:hover {
      background-color: #333;
    }
    .toggle-darkmode {
      margin-left: auto;
    }
    /* --- Chord list grid --- */
    #chordList {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 16px;
      padding-top: 10px;
    }
    #chordList label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #chordList label button {
      background: transparent;
      border: none;
      color: red;
      cursor: pointer;
      font-size: 1em;
    }
    /* --- Inputs & labels --- */
    input[type="text"], select, input[type="number"], input[type="range"] {
      border-radius: 4px;
      border: 1px solid #ccc;
      padding: 5px;
      font-size: 1em;
      margin-left: 8px;
    }
    label {
      font-weight: 600;
    }
    /* --- Rhythm grid --- */
    #rhythmGrid {
      display: grid;
      grid-template-columns: repeat(8, 40px);
      gap: 6px;
      margin-top: 10px;
      user-select: none;
    }
    .beat-box {
      width: 40px;
      height: 40px;
      border: 2px solid #888;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .beat-box.active {
      background-color: #4caf50;
      border-color: #388e3c;
      color: #fff;
    }
    .darkmode .beat-box {
      border-color: #aaa;
    }
    .darkmode .beat-box.active {
      background-color: #81c784;
      border-color: #4caf50;
    }
  </style>
</head>
<body>

  <h1>üé∏ Chorderline</h1>

  <!-- Navigation -->
  <nav class="navbar section-box">
    <button onclick="showPage('info')">Info</button>
    <button onclick="showPage('setup')">Setup</button>
    <button onclick="showPage('chord')">Chord</button>
    <button onclick="showPage('rhythm')">Rhythm</button>
    <button onclick="showPage('preview')">Preview</button>
    <button class="toggle-darkmode" onclick="toggleDarkMode()">Toggle Darkmode</button>
  </nav>

  <!-- Pages -->
  <div id="info" class="page section-box active">
    <h2>Welcome to Chorderline</h2>
    <p>Random post-punk chord & rhythm generator. ‚ÄúSetup‚Äù ‚Üí basic key/tempo/timesig, ‚ÄúChord‚Äù ‚Üí progressions, ‚ÄúRhythm‚Äù ‚Üí beats pattern, ‚ÄúPreview‚Äù ‚Üí hear it.</p>
  </div>

  <div id="setup" class="page section-box" style="display:none;">
    <h2>Setup</h2>
    <div style="display:flex; flex-wrap:wrap; gap:20px;">
      <div>
        <label for="key">Key:</label>
        <select id="key">
          <option>C</option><option>C# / Db</option><option>D</option><option>D# / Eb</option>
          <option>E</option><option>F</option><option>F# / Gb</option><option>G</option>
          <option>G# / Ab</option><option>A</option><option>A# / Bb</option><option>B</option>
        </select>
      </div>
      <div>
        <label for="tempo">Tempo (BPM):</label>
        <input type="number" id="tempo" min="40" max="240" value="120" />
      </div>
      <div>
        <label for="timesig">Time Sig:</label>
        <select id="timesig">
          <option>4/4</option><option>3/4</option><option>6/8</option><option>7/8</option>
        </select>
      </div>
    </div>
  </div>

  <div id="chord" class="page section-box" style="display:none;">
    <h2>Chord Progressions</h2>
    <p>Pick some presets or add your own. Must be uppercase I‚ÄìVII, ‚â•2 chords, dash-separated.</p>
    <div style="margin-bottom:10px;">
      <button onclick="toggleCheckboxes(true)">Apply All</button>
      <button onclick="toggleCheckboxes(false)">Disable All</button>
    </div>
    <div id="chordList">
      <label><input type="checkbox" value="I-V-IV"> I-V-IV</label>
      <label><input type="checkbox" value="I-V-vi-IV"> I-V-vi-IV</label>
      <label><input type="checkbox" value="V-vi-IV"> V-vi-IV</label>
      <label><input type="checkbox" value="i-VII-III-V"> i-VII-III-V</label>
      <!-- ‚Ä¶other defaults‚Ä¶ -->
    </div>
    <div style="margin-top:15px;">
      <input type="text" id="customProg" placeholder="e.g. I-bVII-iiadd9" />
      <button onclick="addCustomProg()">Add</button>
    </div>
    <h3>Extensions & Suspensions</h3>
    <label for="extensionsSlider">Amount:</label>
    <input type="range" id="extensionsSlider" min="0" max="10" value="3" />
  </div>

  <div id="rhythm" class="page section-box" style="display:none;">
    <h2>Rhythm Generator</h2>
    <p>Toggle beats; then press Generate.</p>
    <label for="rhythmBeatsCount">Beats per measure (1‚Äì16):</label>
    <input type="number" id="rhythmBeatsCount" min="1" max="16" value="8" onchange="createRhythmGrid()" />
    <div id="rhythmGrid"></div>
    <button onclick="generateRhythm()">Generate Rhythm</button>
    <h3>Generated Pattern:</h3>
    <p id="rhythmOutput" style="font-family:monospace; font-size:1.2em;"></p>
  </div>

  <div id="preview" class="page section-box" style="display:none;">
    <h2>Preview</h2>
    <p>Key: <span id="previewKey"></span></p>
    <p>Tempo: <span id="previewTempo"></span> BPM</p>
    <p>Time Sig: <span id="previewTimesig"></span></p>
    <p>Chord Prog: <span id="previewProg"></span></p>
    <p>Rhythm: <span id="previewRhythm"></span></p>
  </div>

  <script>
    // === Nav & Darkmode ===
    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.style.display = p.id === id ? 'block' : 'none');
    }
    function toggleDarkMode() {
      document.body.classList.toggle('darkmode');
    }

    // === Checkboxes batch ===
    function toggleCheckboxes(state) {
      document.querySelectorAll('#chordList input[type=checkbox]')
        .forEach(cb => cb.checked = state);
    }

    // === Roman-numeral validation up to VII ===
    function validateRomanNumeralProg(prog) {
      if (!prog || !prog.includes('-')) return false;
      // Must have no spaces around dashes and only ASCII dash
      if (/\s-\s|\u2013|\u2014/.test(prog)) return false;
      const chords = prog.split('-');
      if (chords.length < 2) return false;

      const validNumerals = ['I','II','III','IV','V','VI','VII'];

      for (let raw of chords) {
        const ch = raw.trim();
        // Extract prefix/suffix flat/sharp
        let core = ch.replace(/^[b‚ô≠#‚ôØ]|[b‚ô≠#‚ôØ]$/g, '');
        // Split core into numeral + extension
        let match = core.match(/^([IVX]+)(.*)$/);
        if (!match) return false;
        const [_, rn, ext] = match;
        if (!validNumerals.includes(rn)) return false;
        // Validate ext: allow sus, add, maj, dim, aug + nums, parentheses
        if (ext && !/^(\(?((sus|add|maj|dim|aug)?\d*)\)*)*$/i.test(ext)) return false;
      }
      return true;
    }

    // === Add custom progression ===
    function addCustomProg() {
      const inp = document.getElementById('customProg');
      const val = inp.value.trim();
      if (!validateRomanNumeralProg(val)) {
        alert('Invalid! Use ‚â•2 chords, dash-separated, uppercase I‚ÄìVII, optional b/‚ô≠/#/‚ôØ & sus/add/extensions. No spaces around dashes!');
        return;
      }
      // Check duplicates
      const exists = Array.from(document.querySelectorAll('#chordList input'))
        .some(cb => cb.value === val);
      if (exists) {
        alert('That progression already exists!');
        inp.value = '';
        return;
      }
      const label = document.createElement('label');
      const cb    = document.createElement('input');
      cb.type = 'checkbox'; cb.value = val; cb.checked = true;
      const remove = document.createElement('button');
      remove.textContent = '√ó';
      remove.onclick = e => { e.preventDefault(); label.remove(); };
      label.append(cb, document.createTextNode(' ' + val + ' '), remove);
      document.getElementById('chordList').append(label);
      inp.value = '';
    }

    // === Rhythm grid ===
    function createRhythmGrid() {
      const grid = document.getElementById('rhythmGrid');
      grid.innerHTML = '';
      const count = Math.min(Math.max(+document.getElementById('rhythmBeatsCount').value,1),16);
      for (let i=1; i<=count; i++) {
        const box = document.createElement('div');
        box.className = 'beat-box';
        box.textContent = i;
        box.onclick = () => box.classList.toggle('active');
        grid.append(box);
      }
    }
    createRhythmGrid();

    function generateRhythm() {
      const boxes = [...document.querySelectorAll('.beat-box')];
      if (!boxes.length) return alert('Set beats per measure!');
      const pattern = boxes.map(b => b.classList.contains('active') ? 'x' : '-').join('');
      document.getElementById('rhythmOutput').textContent = pattern;
      document.getElementById('previewRhythm').textContent = pattern;
    }

    // === Preview updates ===
    function updatePreview() {
      document.getElementById('previewKey').textContent = document.getElementById('key').value;
      document.getElementById('previewTempo').textContent = document.getElementById('tempo').value;
      document.getElementById('previewTimesig').textContent = document.getElementById('timesig').value;
      const sel = [...document.querySelectorAll('#chordList input:checked')].map(cb=>cb.value);
      document.getElementById('previewProg').textContent = sel.length
        ? sel[Math.floor(Math.random()*sel.length)]
        : 'No chord progression selected';
    }
    document.querySelectorAll('#key,#tempo,#timesig').forEach(el => el.onchange = updatePreview);
    document.getElementById('chordList').onchange = updatePreview;
    document.querySelector('nav.navbar button[onclick*="preview"]').onclick = () => {
      updatePreview(); showPage('preview');
    };
  </script>

</body>
</html>
