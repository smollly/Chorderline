<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chorderline</title>
<style>
  /* === Your existing CSS === */
  body {
    background: #222;
    color: #ddd;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
  }
  h1 {
    text-align: center;
    margin-top: 20px;
  }
  .navbar {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 10px;
    background: #333;
  }
  .navbar button {
    background: #555;
    color: #eee;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.3s;
  }
  .navbar button:hover {
    background: #777;
  }
  .toggle-darkmode {
    margin-left: auto;
    background: #222;
    color: #eee;
  }
  .section-box {
    max-width: 600px;
    margin: 20px auto;
    background: #333;
    padding: 15px;
    border-radius: 8px;
  }
  label {
    display: block;
    margin: 10px 0 5px;
  }
  input[type="text"], select, textarea {
    width: 100%;
    padding: 6px;
    border-radius: 4px;
    border: 1px solid #555;
    background: #222;
    color: #eee;
  }
  #previewOutput {
    white-space: pre-wrap;
    font-family: monospace;
    background: #222;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #555;
    min-height: 100px;
    margin-top: 10px;
  }
  .hidden {
    display: none;
  }
</style>
</head>
<body>

<h1>ðŸŽ¸ Chorderline</h1>

<nav class="navbar section-box">
  <button onclick="showPage('info')">Info</button>
  <button onclick="showPage('setup')">Setup</button>
  <button onclick="showPage('chord')">Chord</button>
  <button onclick="showPage('rhythm')">Rhythm</button>
  <button onclick="showPage('preview')">Preview</button>
  <button class="toggle-darkmode" onclick="toggleDarkMode()">Toggle Darkmode</button>
</nav>

<!-- Pages -->
<section id="info" class="section-box">
  <h2>Info</h2>
  <p>Welcome to Chorderline! Use the tabs above to navigate.</p>
</section>

<section id="setup" class="section-box hidden">
  <h2>Setup</h2>
  <label for="key">Key:</label>
  <select id="key">
    <option value="C" selected>C</option>
    <option value="C#">C# / Db</option>
    <option value="D">D</option>
    <option value="D#">D# / Eb</option>
    <option value="E">E</option>
    <option value="F">F</option>
    <option value="F#">F# / Gb</option>
    <option value="G">G</option>
    <option value="G#">G# / Ab</option>
    <option value="A">A</option>
    <option value="A#">A# / Bb</option>
    <option value="B">B</option>
  </select>
</section>

<section id="chord" class="section-box hidden">
  <h2>Chord List</h2>
  <p>Select chords to preview:</p>
  <div id="chordList">
    <label><input type="checkbox" value="I" checked /> I</label>
    <label><input type="checkbox" value="ii" checked /> ii</label>
    <label><input type="checkbox" value="iii" checked /> iii</label>
    <label><input type="checkbox" value="IV" checked /> IV</label>
    <label><input type="checkbox" value="V" checked /> V</label>
    <label><input type="checkbox" value="vi" checked /> vi</label>
    <label><input type="checkbox" value="viiÂ°" /> viiÂ°</label>
  </div>
</section>

<section id="rhythm" class="section-box hidden">
  <h2>Rhythm (Work in Progress)</h2>
  <p>Coming soon...</p>
</section>

<section id="preview" class="section-box hidden">
  <h2>Chord Preview</h2>
  <button onclick="previewChords()">Show Chords</button>
  <pre id="previewOutput">Select some chords and click "Show Chords"!</pre>
  <label><input type="checkbox" id="devModeBox" /> Show Debug Info</label>
</section>

<script>
  // === Page Navigation ===
  function showPage(pageId) {
    const pages = ['info','setup','chord','rhythm','preview'];
    pages.forEach(id => {
      document.getElementById(id).classList.toggle('hidden', id !== pageId);
    });
  }

  // Show default page
  showPage('info');

  // === Dark Mode Toggle ===
  function toggleDarkMode() {
    document.body.classList.toggle('darkmode');
    if(document.body.classList.contains('darkmode')) {
      document.body.style.background = '#111';
      document.body.style.color = '#eee';
    } else {
      document.body.style.background = '#222';
      document.body.style.color = '#ddd';
    }
  }

  // === Chord Parsing Utilities ===
  const notesSharp = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const notesFlat  = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];

  const majorDeg = { I:0, II:2, III:4, IV:5, V:7, VI:9, VII:11 };
  const minorDeg = { i:0, ii:2, iii:3, iv:5, v:7, vi:8, vii:10 };

  // Normalize accidentals
  function normAcc(a){
    return a.replace('â™­','b').replace('â™¯','#');
  }
  // Get index of note in notesSharp or notesFlat arrays
  function idxOf(n){
    let i = notesSharp.indexOf(n);
    if(i >= 0) return i;
    return notesFlat.indexOf(n);
  }

  // NEW Chord parsing function that handles Roman numerals with accidentals and extensions
  function parseChordSymbol(chord, key) {
    chord = chord.trim();
    // Regex breakdown:
    // ^([b#â™­â™¯]?)([IViv]+)(.*)?$
    // Group 1 = accidental modifier before numeral (b, #, â™­, â™¯)
    // Group 2 = roman numeral chord degree
    // Group 3 = any extensions or alterations after numeral (like Â°, dim, maj7, sus4)
    const match = /^([b#â™­â™¯]?)([IViv]+)(.*)?$/.exec(chord);
    if (!match) {
      return { error: `Could not parse chord symbol '${chord}'` };
    }

    let [, acc, roman, ext] = match;
    acc = normAcc(acc);
    ext = ext || '';

    // Determine if major or minor by checking case of roman numeral
    const isMajor = roman === roman.toUpperCase();
    const map = isMajor ? majorDeg : minorDeg;

    // Fix roman numeral like viiÂ° -> vii (strip any trailing special chars before lookup)
    let baseRoman = roman.toUpperCase();
    // Special fix: minor degrees map keys are lowercase roman numerals, so handle that
    if (!isMajor) baseRoman = roman.toLowerCase();

    let sem = map[baseRoman];
    if (sem === undefined) {
      return { error: `Unknown roman numeral degree '${roman}' in chord '${chord}'` };
    }

    // Apply accidental modifiers
    if (acc === 'b') sem--;
    if (acc === '#') sem++;

    // Wrap around 0-11 semitones
    sem = (sem + 12) % 12;

    // Find the key root index
    const keyIndex = idxOf(key);
    if (keyIndex < 0) {
      return { error: `Unknown key '${key}'` };
    }

    // Calculate final note name
    const note = notesSharp[(keyIndex + sem) % 12];

    // Determine chord quality
    // If chord has dim or Â° in extension, mark as diminished
    // If chord has aug, mark as augmented
    // Else if minor chord, add 'm', else no suffix for major
    let quality = '';
    if (/dim|o|Â°/.test(ext)) {
      quality = 'dim';
    } else if (/aug/.test(ext)) {
      quality = 'aug';
    } else {
      quality = isMajor ? '' : 'm';
    }

    // Compose full chord name (note + quality + extension)
    const displayChord = `${note}${quality}${ext}`;

    return { display: displayChord };
  }

  // === Main preview function ===
  function previewChords() {
    const key = document.getElementById('key').value;
    const outs = document.getElementById('previewOutput');
    const devb = document.getElementById('devModeBox').checked;
    const selectedCheckboxes = document.querySelectorAll('#chordList input:checked');
    const selectedChords = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (selectedChords.length === 0) {
      outs.textContent = 'No chords selected!';
      return;
    }

    let outputText = `Key: ${key}\n\n`;
    let debugText = '';

    selectedChords.forEach(chordSymbol => {
      const parsed = parseChordSymbol(chordSymbol, key);
      if (parsed.error) {
        outputText += `${chordSymbol}: ERROR (${parsed.error})\n`;
        if (devb) debugText += `Parsing failed for '${chordSymbol}': ${parsed.error}\n`;
      } else {
        outputText += `${chordSymbol}: ${parsed.display}\n`;
      }
    });

    if (devb && debugText) {
      outputText += `\n--- DEBUG INFO ---\n${debugText}`;
    }

    outs.textContent = outputText;
  }
</script>

</body>
</html>
