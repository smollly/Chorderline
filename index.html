import re
import random
import gradio as gr

# 🎼 Chord progression validation
ROMAN_NUMERAL_REGEX = r'(b?((I{1,3})|(IV)|(V)|(VI{0,1})|(VII)|' \
                      r'(i{1,3})|(iv)|(v)|(vi{0,1})|(vii)))'
CHORD_EXTENSIONS_REGEX = r'(maj7|maj9|add9|add11|sus2|sus4|dim|aug|o|°|7|9|11|13)?'
CHORD_REGEX = re.compile(rf'^{ROMAN_NUMERAL_REGEX}{CHORD_EXTENSIONS_REGEX}$')

def validate_chord_progression(prog_str):
    prog_str = re.sub(r'\s*[-–]\s*', '-', prog_str.strip())  # Clean spacing/dashes
    chords = prog_str.split('-')
    for chord in chords:
        if not CHORD_REGEX.match(chord):
            return False, f"Invalid chord: {chord}"
    return True, chords

# 🎲 Random chord progression from allowed chords
allowed_chords = [
    "I", "ii", "iii", "IV", "V", "vi", "vii°",
    "bII", "bIII", "bVI", "bVII",
    "i", "biii", "iv", "v", "bVI", "bVII"
]

def generate_random_progression():
    return " - ".join(random.choices(allowed_chords, k=4))

# 🌟 Main function
def make_progression(mode, custom_input):
    if mode == "Random":
        return generate_random_progression()
    elif mode == "Custom":
        valid, result = validate_chord_progression(custom_input)
        if valid:
            return " - ".join(result)
        else:
            return f"❌ {result}"
    return ""

# 🌈 UI Stuff
with gr.Blocks() as app:
    gr.Markdown("## 🎸 Emo Chord Progression Generator")
    mode = gr.Radio(["Random", "Custom"], label="Select Mode", value="Random")
    custom_input = gr.Textbox(label="Enter Custom Progression (like I - V7 - bVIadd9 - iv)")
    output = gr.Textbox(label="🎶 Your Progression")

    go_btn = gr.Button("Generate!")

    go_btn.click(fn=make_progression, inputs=[mode, custom_input], outputs=[output])

# 🚀 Launch
app.launch()
