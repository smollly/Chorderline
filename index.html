<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chorderline</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f0f0;
      color: #000;
      padding: 20px;
      transition: background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
      position: relative;
    }
    .dark-mode {
      background-color: #121212;
      color: #eee;
    }
    .section-box {
      background: #fff;
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: background 0.3s ease;
    }
    .dark-mode .section-box {
      background: #222;
      box-shadow: 0 2px 10px rgba(0,0,0,0.8);
    }
    .navbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 25px;
    }
    .navbar button, .dark-toggle button {
      background: transparent;
      border: none;
      font-weight: 600;
      cursor: pointer;
      padding: 8px 14px;
      border-radius: 6px;
      transition: color 0.3s ease, background-color 0.3s ease;
      color: black;
    }
    .dark-mode .navbar button,
    .dark-mode .dark-toggle button {
      color: white;
    }
    .dark-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    #chordList {
      max-height: 220px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap: 8px 15px;
      padding-top: 10px;
    }
    #chordList label {
      user-select: none;
    }
    #customProg {
      width: 250px;
      padding: 6px 8px;
      border-radius: 5px;
      border: 1px solid #aaa;
      margin-right: 8px;
      font-size: 1em;
    }
    #generationResult {
      background: #eee;
      border-radius: 8px;
      padding: 15px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 1.1em;
      line-height: 1.5;
      margin-top: 20px;
      user-select: text;
      min-height: 160px;
      box-shadow: inset 0 0 6px #ccc;
      transition: background 0.3s ease, color 0.3s ease;
    }
    .dark-mode #generationResult {
      background: #333;
      box-shadow: inset 0 0 10px #555;
      color: #ddd;
    }
    label[for="extensionsRange"] {
      font-weight: 600;
      margin-top: 20px;
      display: block;
    }
    #extensionsRange {
      width: 100%;
      margin-top: 5px;
      cursor: pointer;
    }
    #extensionsValue {
      font-weight: 700;
      margin-left: 10px;
    }
    /* Show/Hide pages */
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
  </style>
</head>
<body>

  <h1>üé∏ Chorderline</h1>

  <div class="dark-toggle">
    <button id="darkModeBtn" onclick="toggleDarkMode()">Toggle Darkmode</button>
  </div>

  <nav class="navbar">
    <button onclick="showPage('info')">Info</button>
    <button onclick="showPage('setup')">Setup</button>
    <button onclick="showPage('chord')">Chord</button>
    <button onclick="showPage('rhythm')">Rhythm</button>
    <button onclick="showPage('preview')">Preview</button>
  </nav>

  <div id="info" class="page section-box active">
    <h2>Welcome to Chorderline</h2>
    <p>This is a random post-punk chord & rhythm generator. Move through each tab to configure your generation. ‚ÄúSetup‚Äù handles basic key info, ‚ÄúChord‚Äù handles progressions, and so on. Simple as that.</p>
  </div>

  <div id="setup" class="page section-box">
    <h2>Setup</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
      <div>
        <label for="key">Key:</label><br />
        <select id="key" aria-label="Select Key">
          <option value="C">C</option>
          <option value="C#">C# / Db</option>
          <option value="D">D</option>
          <option value="D#">D# / Eb</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="F#">F# / Gb</option>
          <option value="G">G</option>
          <option value="G#">G# / Ab</option>
          <option value="A">A</option>
          <option value="A#">A# / Bb</option>
          <option value="B">B</option>
        </select>
      </div>
      <div>
        <label for="tempo">Tempo (BPM):</label><br />
        <input type="number" id="tempo" min="40" max="240" value="120" />
      </div>
      <div>
        <label for="timesig">Time Signature:</label><br />
        <select id="timesig">
          <option value="4/4">4/4</option>
          <option value="3/4">3/4</option>
          <option value="6/8">6/8</option>
        </select>
      </div>
    </div>
  </div>

  <div id="chord" class="page section-box">
    <h2>Chord Progressions</h2>
    <p>Select one or more progressions. A random one will be chosen for generation. You can also add your own!</p>
    <div style="margin-bottom: 10px;">
      <button onclick="toggleCheckboxes(true)">Apply All</button>
      <button onclick="toggleCheckboxes(false)">Disable All</button>
    </div>
    <div id="chordList">
      <label><input type="checkbox" value="I - V - IV" /> I - V - IV</label>
      <label><input type="checkbox" value="I - V - vi - IV" /> I - V - vi - IV</label>
      <label><input type="checkbox" value="V - vi - IV" /> V - vi - IV</label>
      <label><input type="checkbox" value="i - VI - III - V" /> i - VI - III - V</label>
      <label><input type="checkbox" value="I - V - vi - IV - ii - V" /> I - V - vi - IV - ii - V</label>
      <label><input type="checkbox" value="I - V - vi - IV - I" /> I - V - vi - IV - I</label>
      <label><input type="checkbox" value="I - iii - ii - V" /> I - iii - ii - V</label>
      <label><input type="checkbox" value="i - VII - III - v" /> i - VII - III - v</label>
      <label><input type="checkbox" value="vi - I - V - IV" /> vi - I - V - IV</label>
      <label><input type="checkbox" value="i - VI - v - VII" /> i - VI - v - VII</label>
      <label><input type="checkbox" value="I - V - IV - V - vi" /> I - V - IV - V - vi</label>
      <label><input type="checkbox" value="i - VI - iv - VII" /> i - VI - iv - VII</label>
      <label><input type="checkbox" value="I - vi - iii - IV" /> I - vi - iii - IV</label>
      <label><input type="checkbox" value="vi - ‚ô≠VII - V - I" /> vi - ‚ô≠VII - V - I</label>
      <label><input type="checkbox" value="I - II - IV - V" /> I - II - IV - V</label>
      <label><input type="checkbox" value="I - IV - vi - IV" /> I - IV - vi - IV</label>
      <label><input type="checkbox" value="i - III - vi - V" /> i - III - vi - V</label>
      <label><input type="checkbox" value="VI - III - VII - i" /> VI - III - VII - i</label>
      <label><input type="checkbox" value="I - V - vi - II" /> I - V - vi - II</label>
      <label><input type="checkbox" value="vi - I - IV - iii" /> vi - I - IV - iii</label>
      <label><input type="checkbox" value="I - vi - IV" /> I - vi - IV</label>
    </div>

    <div style="margin-top: 15px;">
      <label for="customProg">Custom progression (optional):</label><br />
      <input type="text" id="customProg" placeholder="e.g. i - iv - ‚ô≠VII - v" />
      <button onclick="addCustomProg()">‚úîÔ∏è</button>
    </div>

    <!-- Extensions & Suspensions slider -->
    <label for="extensionsRange">
      Extensions & Suspensions Amount <span id="extensionsValue">50</span>%
    </label>
    <input
      type="range"
      id="extensionsRange"
      min="0"
      max="100"
      value="50"
      oninput="document.getElementById('extensionsValue').textContent = this.value"
    />
  </div>

  <div id="rhythm" class="page section-box">
    <h2>Rhythm</h2>
    <p>Rhythm settings coming soon...</p>
  </div>

  <div id="preview" class="page section-box">
    <h2>Preview & Generate</h2>
    <button onclick="generateChordProgression()" style="margin-bottom:10px;">Generate!</button>
    <div id="generationResult">Hit Generate to see the magic ‚ú®</div>
  </div>

<script>
  // Global State
  let customProgressions = [];

  // Show the selected page, hide others
  function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => {
      p.classList.remove('active');
      p.style.display = 'none';
    });
    const page = document.getElementById(pageId);
    page.style.display = 'block';
    page.classList.add('active');
  }

  // Dark mode toggle with fade effect
  function toggleDarkMode() {
    const body = document.body;
    if(body.classList.contains('dark-mode')) {
      body.classList.remove('dark-mode');
    } else {
      body.classList.add('dark-mode');
    }
  }

  // Apply or disable all chord checkboxes
  function toggleCheckboxes(state) {
    document.querySelectorAll('#chordList input[type=checkbox]').forEach(chk => {
      chk.checked = state;
    });
  }

  // Add custom progression from input box
  function addCustomProg() {
    const input = document.getElementById('customProg');
    const val = input.value.trim();
    if(val === '') {
      alert('Please enter a valid progression!');
      return;
    }
    // Validate input - must have Roman numeral-like pattern separated by "-"
    if(!/^([iIvV]+|‚ô≠?[IViv]+)(\s*-\s*([iIvV]+|‚ô≠?[IViv]+))*$/.test(val)) {
      alert('Please enter valid roman numeral progression, e.g. "i - iv - ‚ô≠VII - v"');
      return;
    }
    customProgressions.push(val);
    // Add to checkbox list dynamically
    const chordList = document.getElementById('chordList');
    const label = document.createElement('label');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = val;
    checkbox.checked = true;
    label.appendChild(checkbox);
    label.append(' ' + val);
    chordList.appendChild(label);
    input.value = '';
  }

  // -----------------
  // MUSIC THEORY HELPERS
  // -----------------

  // Chromatic scale for reference, sharps only (flats handled later)
  const CHROMATIC_SHARPS = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
  // Flats equivalent map for keys (to convert flats to sharps)
  const FLAT_TO_SHARP = {
    'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#', 'Cb': 'B', 'Fb': 'E'
  };

  // Map roman numeral to scale degree (1-based)
  // Handles ‚ô≠ (flat) for lowered scale degrees like ‚ô≠VII
  function romanToDegree(rn) {
    rn = rn.trim();
    // Remove any whitespace
    // Detect if there's a flat symbol (‚ô≠)
    let flat = false;
    if(rn.startsWith('‚ô≠')) {
      flat = true;
      rn = rn.slice(1);
    }
    // Convert roman numeral to integer 1-7 (basic ones only)
    // I=1, II=2, III=3, IV=4, V=5, VI=6, VII=7
    const romanMap = {I:1, II:2, III:3, IV:4, V:5, VI:6, VII:7};
    // Normalize uppercase for checking:
    const upperRn = rn.toUpperCase();

    let degree = romanMap[upperRn] || null;
    if(degree === null) return null; // unknown numeral

    if(flat) {
      degree = degree - 1;
      if(degree < 1) degree = 7; // wrap around to 7
    }
    return degree;
  }

  // Parse a chord numeral to extract info
  // Returns an object { degree, isMinor, isMajor, isDiminished, isAugmented, raw }
  // We'll decide minor/major based on case (lowercase minor, uppercase major)
  // and common chords (diminished often with ¬∞ but ignored here)
  function parseChordNumeral(numeral) {
    numeral = numeral.trim();
    let raw = numeral;

    // Detect flat ‚ô≠ and remove for now
    let hasFlat = false;
    if(numeral.startsWith('‚ô≠')) {
      hasFlat = true;
      numeral = numeral.slice(1);
    }

    // Determine minor or major by case of first letter (i is minor, I is major)
    let isMinor = /^[iv]+$/.test(numeral);
    let isMajor = !isMinor;

    // Also detect diminished or augmented (optional, ignored here for simplicity)

    // Remove any other characters like sus, add7 etc - will add later
    // We'll parse extensions/sus later in chord extensions logic

    return {
      raw,
      numeral,
      hasFlat,
      isMinor,
      isMajor,
      degree: romanToDegree(raw)
    };
  }

  // Build major scale for a given root note (sharp name) - returns array of notes
  function buildMajorScale(root) {
    // Major scale intervals in semitones: W-W-H-W-W-W-H => 2-2-1-2-2-2-1
    const intervals = [2,2,1,2,2,2,1];
    let scale = [root];
    let rootIdx = CHROMATIC_SHARPS.indexOf(root);
    if(rootIdx === -1) {
      // try convert flats to sharps
      root = FLAT_TO_SHARP[root] || root;
      rootIdx = CHROMATIC_SHARPS.indexOf(root);
      if(rootIdx === -1) return [];
    }
    let currentIdx = rootIdx;
    for(let i=0; i<intervals.length-1; i++) {
      currentIdx = (currentIdx + intervals[i]) % 12;
      scale.push(CHROMATIC_SHARPS[currentIdx]);
    }
    return scale;
  }

  // Build minor scale (natural minor) for given root note
  function buildMinorScale(root) {
    // Natural minor intervals: W-H-W-W-H-W-W => 2-1-2-2-1-2-2
    const intervals = [2,1,2,2,1,2,2];
    let scale = [root];
    let rootIdx = CHROMATIC_SHARPS.indexOf(root);
    if(rootIdx === -1) {
      root = FLAT_TO_SHARP[root] || root;
      rootIdx = CHROMATIC_SHARPS.indexOf(root);
      if(rootIdx === -1) return [];
    }
    let currentIdx = rootIdx;
    for(let i=0; i<intervals.length-1; i++) {
      currentIdx = (currentIdx + intervals[i]) % 12;
      scale.push(CHROMATIC_SHARPS[currentIdx]);
    }
    return scale;
  }

  // Determine chord quality based on scale type and degree for major key
  // Returns chord name root + chord quality (maj, min, dim)
  function getChordForDegree(degree, isMinorKey = false) {
    if(isMinorKey) {
      // Natural minor triads (i ii¬∞ III iv v VI VII)
      // degree 1:i min, 2:dim, 3:maj, 4:min, 5:min, 6:maj, 7:maj
      const qualities = ['min', 'dim', 'maj', 'min', 'min', 'maj', 'maj'];
      return qualities[degree - 1];
    } else {
      // Major key triads (I ii iii IV V vi vii¬∞)
      // degree 1:maj, 2:min, 3:min, 4:maj, 5:maj, 6:min, 7:dim
      const qualities = ['maj', 'min', 'min', 'maj', 'maj', 'min', 'dim'];
      return qualities[degree - 1];
    }
  }

  // Add extensions and suspensions based on slider value and randomness
  function applyExtensions(chordName, extensionPercent) {
    // extensionPercent is 0-100, chance to add extensions
    // We'll randomly add 7, sus2, sus4, add9 chords

    const chance = extensionPercent / 100;
    const rand = Math.random();

    if(rand > chance) return chordName; // no extension

    // Possible extensions to add
    const extList = ['7', 'sus2', 'sus4', 'add9'];
    const chosen = extList[Math.floor(Math.random() * extList.length)];

    // Don't double-up extensions, just append
    if(chordName.includes(chosen)) return chordName;

    // Append extension nicely
    return chordName + chosen;
  }

  // Convert roman numeral progression string to actual chords in the key
  function convertProgression(progStr, keyRoot, isMinorKey = false, extensionPercent = 50) {
    const scale = isMinorKey ? buildMinorScale(keyRoot) : buildMajorScale(keyRoot);
    if(scale.length === 0) return 'Invalid key';

    const chords = [];

    // Split progression into tokens, like "i - iv - ‚ô≠VII - v"
    const tokens = progStr.split('-').map(t => t.trim()).filter(t => t.length > 0);

    tokens.forEach(token => {
      const parsed = parseChordNumeral(token);
      if(!parsed || parsed.degree === null) {
        chords.push('???');
        return;
      }

      let degree = parsed.degree;
      // Fix flats if needed (‚ô≠VII becomes degree 6, etc handled in romanToDegree)
      // degree is 1-based scale degree

      // Note root from scale (wrap around for ‚ô≠VII or others)
      let rootNote = scale[(degree - 1) % scale.length];

      // Determine chord quality
      let quality = getChordForDegree(degree, isMinorKey);

      // Format chord name
      let chordName = rootNote;

      if(quality === 'min') chordName += 'm';
      else if(quality === 'dim') chordName += 'dim';

      // Apply extensions/sus based on slider
      chordName = applyExtensions(chordName, extensionPercent);

      chords.push(chordName);
    });

    return chords.join(' - ');
  }

  // Main generation function
  function generateChordProgression() {
    const key = document.getElementById('key').value;
    const tempo = document.getElementById('tempo').value;
    const timesig = document.getElementById('timesig').value;

    // Determine if key is minor (rudimentary check)
    // For now, assume minor if key name ends with 'm' or user sets in future (todo)
    const isMinorKey = false;

    // Gather checked progressions from checkbox list + custom
    const checkedBoxes = [...document.querySelectorAll('#chordList input[type=checkbox]:checked')];
    if(checkedBoxes.length === 0) {
      alert('Please select at least one progression!');
      return;
    }

    const selectedProgs = checkedBoxes.map(cb => cb.value);
    // Pick one randomly
    const selectedProg = selectedProgs[Math.floor(Math.random() * selectedProgs.length)];

    const extensionPercent = parseInt(document.getElementById('extensionsRange').value);

    // Convert to actual chords
    const chordString = convertProgression(selectedProg, key, isMinorKey, extensionPercent);

    // Prepare output
    let output = `Key: ${key}\nTempo: ${tempo} BPM\nTime Signature: ${timesig}\n\nProgression: ${selectedProg}\nGenerated Chords:\n${chordString}`;

    // Show output in preview panel
    const preview = document.getElementById('generationResult');
    preview.textContent = output;
  }
</script>

</body>
</html>
