<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chorderline</title>
  <style>
    body {
      background-color: #f0f0f0;
      color: #000;
      font-family: sans-serif;
      padding: 20px;
      transition: background-color 0.5s, color 0.5s;
    }
    .darkmode {
      background-color: #121212;
      color: #fff;
    }
    .section-box {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: background-color 0.5s, color 0.5s;
    }
    .darkmode .section-box {
      background: #1e1e1e;
      color: #fff;
      box-shadow: none;
    }
    nav.navbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
    }
    nav.navbar button {
      background: none;
      border: 1px solid currentColor;
      border-radius: 6px;
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
      color: inherit;
      transition: background-color 0.3s;
    }
    nav.navbar button:hover {
      background-color: #ddd;
    }
    .darkmode nav.navbar button:hover {
      background-color: #333;
    }

    /* ========== CHORD LIST ========== */
    #chordList {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 16px;
      padding-top: 10px;
    }
    #chordList label {
      position: relative;
      padding-right: 30px;
      display: flex;
      align-items: center;
    }
    #chordList label button {
      position: absolute;
      right: 4px;
      background: transparent;
      border: none;
      color: red;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.2em;
      user-select: none;
    }

    .toggle-darkmode {
      margin-left: auto;
      font-weight: bold;
    }
    input[type="text"], select, input[type="number"] {
      border-radius: 4px;
      border: 1px solid #ccc;
      padding: 5px;
      font-size: 1em;
      margin-left: 8px;
    }
    input[type="number"] {
      width: 80px;
    }
    label {
      font-weight: 600;
    }

    /* Rhythm grid styling */
    #rhythmGrid {
      display: grid;
      grid-template-columns: repeat(8, 40px);
      gap: 6px;
      margin-top: 10px;
      user-select: none;
    }
    .beat-box {
      width: 40px;
      height: 40px;
      border: 2px solid #888;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .beat-box.active {
      background-color: #4caf50;
      border-color: #388e3c;
      color: white;
    }
    .darkmode .beat-box {
      border-color: #aaa;
    }
    .darkmode .beat-box.active {
      background-color: #81c784;
      border-color: #4caf50;
    }

    /* ======= DEV MODE BOX ======= */
    #devModeBox {
      background: #222;
      color: #0f0;
      font-family: monospace;
      white-space: pre-wrap;
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
  </style>
</head>
<body>

  <h1>üé∏ Chorderline</h1>

  <!-- Navigation -->
  <nav class="navbar section-box">
    <button onclick="showPage('info')">Info</button>
    <button onclick="showPage('setup')">Setup</button>
    <button onclick="showPage('chord')">Chord</button>
    <button onclick="showPage('rhythm')">Rhythm</button>
    <button onclick="showPage('preview')">Preview</button>
    <button class="toggle-darkmode" onclick="toggleDarkMode()">Toggle Darkmode</button>
  </nav>

  <!-- Pages -->
  <div id="info" class="page section-box active">
    <h2>Welcome to Chorderline</h2>
    <p>This is a random post-punk chord & rhythm generator. Move through each tab to configure your generation. ‚ÄúSetup‚Äù handles basic key info, ‚ÄúChord‚Äù handles progressions, and so on. Simple as that.</p>
  </div>

  <div id="setup" class="page section-box" style="display:none;">
    <h2>Setup</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
      <div>
        <label for="key">Key:</label>
        <select id="key">
          <option value="C">C</option>
          <option value="C#">C# / Db</option>
          <option value="D">D</option>
          <option value="D#">D# / Eb</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="F#">F# / Gb</option>
          <option value="G">G</option>
          <option value="G#">G# / Ab</option>
          <option value="A">A</option>
          <option value="A#">A# / Bb</option>
          <option value="B">B</option>
        </select>
      </div>
      <div>
        <label for="tempo">Tempo (BPM):</label>
        <input type="number" id="tempo" min="40" max="240" value="120" />
      </div>
      <div>
        <label for="timesig">Time Signature:</label>
        <select id="timesig">
          <option value="4/4">4/4</option>
          <option value="3/4">3/4</option>
          <option value="6/8">6/8</option>
          <option value="7/8">7/8</option>
        </select>
      </div>
    </div>
  </div>

  <div id="chord" class="page section-box" style="display:none;">
    <h2>Chord Progressions</h2>
    <p>
      Select one or more progressions below. Chorderline will pick one at random when generating.
      These are written using Roman numerals for flexibility across keys and modes.
      You can also enter your own progression if you don‚Äôt see one you like.
    </p>

    <div style="margin-bottom: 10px;">
      <button onclick="toggleCheckboxes(true)">Apply All</button>
      <button onclick="toggleCheckboxes(false)">Disable All</button>
    </div>

    <div id="chordList">
      <!-- your original checkboxes here -->
      <label><input type="checkbox" value="I - V - IV" /> I - V - IV</label>
      <!-- ‚Ä¶ etc ‚Ä¶ -->
      <label><input type="checkbox" value="I - bVII - IV" /> I - bVII - IV</label>
    </div>

    <div style="margin-top: 10px;">
      <label for="customProg">Custom progression:</label>
      <input type="text" id="customProg" placeholder="Eg. I - IV - V" />
      <button onclick="addCustomProg()">Add</button>
      <p id="customProgError" style="color:red; display:none;">Invalid progression format!</p>
    </div>

    <!-- NEW Preview Section -->
    <div style="margin-top: 20px;">
      <button onclick="previewChords()">Preview Progression in Key</button>
      <div id="previewOutput" style="margin-top:15px; font-weight:600;"></div>
      <div id="devModeBox"></div>
    </div>
  </div>

  <div id="rhythm" class="page section-box" style="display:none;">
    <h2>Rhythm Pattern</h2>
    <p>Click on the boxes below to toggle beats on/off for an 8-beat pattern:</p>
    <div id="rhythmGrid"></div>
    <p><button onclick="resetRhythm()">Reset Pattern</button></p>
  </div>

  <div id="preview" class="page section-box" style="display:none;">
    <h2>Preview</h2>
    <p>Coming soon! (Imagine some sick chord + rhythm jam here)</p>
  </div>

  <script>
    // === Darkmode & Nav ===
    function toggleDarkMode() {
      document.body.classList.toggle('darkmode');
    }
    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => {
        p.style.display = 'none'; p.classList.remove('active');
      });
      document.getElementById(id).style.display = 'block';
      document.getElementById(id).classList.add('active');
    }

    // === Toggle All Checkboxes ===
    function toggleCheckboxes(on) {
      document.querySelectorAll('#chordList input[type=checkbox]')
        .forEach(cb => cb.checked = on);
    }

    // === Validation for custom chords ===
    function validateRomanNumeralProg(prog) {
      if (!prog || !prog.trim()) return false;
      const chords = prog.split(/\s*[-‚Äì‚Äî]\s*/);
      if (chords.length < 2) return false;

      // Flats/sharps before numeral, extensions (sus/add/maj/dim/aug/o) after.
      const chordRegex = /^([b‚ô≠#‚ôØ]?)([IV]+|[iv]+)(\(?((sus|add|maj|dim|aug|o)?[0-9]*)\)?)?$/;

      for (let ch of chords) {
        ch = ch.trim();
        const m = chordRegex.exec(ch);
        if (!m) return false;
        const num = m[2];
        // no mixed-case in the numeral
        if (/[IV]/.test(num) && /[iv]/.test(num)) return false;
      }
      return true;
    }

    // === Add Custom Progression ===
    function addCustomProg() {
      const inp = document.getElementById('customProg');
      const val = inp.value.trim();
      const err = document.getElementById('customProgError');

      if (!validateRomanNumeralProg(val)) {
        err.style.display = 'block';
        return;
      }
      err.style.display = 'none';

      // prevent dupes
      const exists = [...document.querySelectorAll('#chordList label')]
        .some(lbl => lbl.textContent.trim() === val);
      if (exists) {
        alert('This progression already exists!');
        return;
      }

      const list = document.getElementById('chordList');
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.value = val; cb.checked = true;
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + val));

      const btn = document.createElement('button');
      btn.textContent = '‚úñ';
      btn.title = 'Remove progression';
      btn.onclick = e => {
        e.preventDefault();
        list.removeChild(label);
      };
      label.appendChild(btn);
      list.appendChild(label);
      inp.value = '';
    }

    // === Rhythm Logic ===
    const rhythmGrid = document.getElementById('rhythmGrid');
    const beats = [];
    for (let i = 0; i < 8; i++) {
      const box = document.createElement('div');
      box.className = 'beat-box';
      box.textContent = i+1;
      box.onclick = () => {
        box.classList.toggle('active');
        beats[i] = box.classList.contains('active');
      };
      rhythmGrid.appendChild(box);
      beats.push(false);
    }
    function resetRhythm() {
      beats.fill(false);
      document.querySelectorAll('.beat-box').forEach(b => b.classList.remove('active'));
    }

    // === Chord ‚Üí Note Parsing & Preview ===
    const notesSharp = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const notesFlat  = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
    const majorDeg   = { I:0, II:2, III:4, IV:5, V:7, VI:9, VII:11 };
    const minorDeg   = { i:0, ii:2, iii:3, iv:5, v:7, VI:8, VII:10 };

    function normAcc(a) { return a.replace('‚ô≠','b').replace('‚ôØ','#'); }
    function idxOf(note) {
      const i = notesSharp.indexOf(note); 
      return i >= 0 ? i : notesFlat.indexOf(note);
    }

    function parseChordSymbol(chord, keyRoot) {
      const re = /^([b#]?)([IViv]+)(\(?((sus|add|maj|dim|aug|o)?[0-9]*)\)?)?$/;
      const m = re.exec(chord);
      if (!m) return null;
      const acc = normAcc(m[1]);
      const num = m[2];
      const ext = m[4] || '';
      const degMap = /[IV]/.test(num) ? majorDeg : minorDeg;
      let semis = degMap[num];
      if (acc==='b') semis--; if(acc==='#') semis++;
      semis = (semis + 12)%12;
      const rootIdx = idxOf(keyRoot);
      const note    = notesSharp[(rootIdx+semis)%12];
      let quality = /dim|o/.test(ext)  ? 'dim'
                  : /aug/.test(ext)   ? 'aug'
                  : /[IV]/.test(num)  ? 'maj'
                  : 'min';
      return { 
        display: `${note}${quality!=='maj'?quality:''}${ext}` 
      };
    }

    function previewChords() {
      const key  = document.getElementById('key').value;
      const outs = document.getElementById('previewOutput');
      const devb = document.getElementById('devModeBox');
      const sel  = [...document.querySelectorAll('#chordList input:checked')];
      if (!sel.length) {
        outs.textContent = 'No progressions selected!';
        devb.style.display = 'none';
        return;
      }
      let text='', dev='';
      sel.forEach((cb,i) => {
        text += `Prog ${i+1}: ${cb.value}\n`;
        const parts = cb.value.split(/\s*[-‚Äì‚Äî]\s*/).map(ch => {
          const p = parseChordSymbol(ch, key);
          dev += p
            ? `${ch} ‚Üí ${p.display}\n`
            : `‚úñ failed to parse ${ch}\n`;
          return p ? p.display : `${ch}(?)`;
        });
        text += parts.join(' - ') + '\n\n';
      });
      outs.textContent = text;
      devb.textContent    = dev;
      devb.style.display  = devMode ? 'block' : 'none';
    }

    // Toggle Dev Mode with F9
    let devMode = false;
    document.addEventListener('keydown', e => {
      if (e.key==='F9') {
        devMode = !devMode;
        document.getElementById('devModeBox').style.display = devMode ? 'block' : 'none';
      }
    });
  </script>
</body>
</html>
